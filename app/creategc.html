<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Group Chat</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
</head>
<body class="bg-dark text-light">

  <div class="container py-5">
    <h2>Create a New Group Chat</h2>

    <!-- Search Box -->
    <div class="mb-3">
      <input type="text" id="userSearch" class="form-control" placeholder="Search users…" />
    </div>

    <!-- User List -->
    <div id="usersContainer" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;">
      <div class="text-center text-muted p-3">Loading users…</div>
    </div>

    <!-- Create Button -->
    <button id="createGroupBtn" class="btn btn-primary">Start Group Chat</button>
  </div>
<button onclick="goBack()" class="btn btn-secondary mb-3">
  ← Back
</button>

<script>
  function goBack() {
    window.history.back();
  }
</script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const usersContainer = document.getElementById('usersContainer');
      const userSearch = document.getElementById('userSearch');
      const createGroupBtn = document.getElementById('createGroupBtn');

      let allUsers = [];

      async function loadUsers() {
        try {
          const res = await fetch('/api/users');
          if (!res.ok) throw new Error('Network error');
          allUsers = await res.json();

          if (allUsers.length === 0) {
            usersContainer.innerHTML = `<div class="text-center text-muted p-3">No users found.</div>`;
            return;
          }

          renderUserList(allUsers);
        } catch (e) {
          console.error(e);
          usersContainer.innerHTML = `<div class="text-center text-danger p-3">Failed to load users.</div>`;
        }
      }

      function renderUserList(users) {
        usersContainer.innerHTML = '';
        users.forEach(u => {
          const item = document.createElement('label');
          item.className = 'list-group-item d-flex align-items-center';
          item.innerHTML = `
            <input class="form-check-input me-2" type="checkbox" value="${u.id}">
            <span>${u.username}</span>
          `;
          usersContainer.appendChild(item);
        });
      }

      userSearch.addEventListener('input', () => {
        const term = userSearch.value.toLowerCase();
        const filtered = allUsers.filter(u => u.username.toLowerCase().includes(term));
        renderUserList(filtered);
      });

      createGroupBtn.addEventListener('click', async () => {
        const selectedIds = Array.from(
          usersContainer.querySelectorAll('input[type="checkbox"]:checked')
        ).map(cb => cb.value);

        if (selectedIds.length < 2) {
          alert('Select at least 2 users to create a group chat.');
          return;
        }

        try {
          const res = await fetch('/api/chats/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_ids: selectedIds })
          });
          const data = await res.json();
          if (res.ok) {
            alert('Group chat created!');
           
          } else {
            alert(data.error || 'Failed to create group chat');
          }
        } catch (e) {
          console.error(e);
          alert('Error creating group chat');
        }
      });

      loadUsers();
    });
  </script>

</body>
</html>
