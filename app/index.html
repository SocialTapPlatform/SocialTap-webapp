<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>SocialTap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    .chat-messages {
      height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      background-color: #1e1e1e;
      border-radius: 0.5rem;
    }
    .message {
      max-width: 75%;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      position: relative;
    }
    .message.own {
      background-color: #0d6efd;
      color: white;
      align-self: flex-end;
      margin-left: auto;
    }
    .message.other {
      background-color: #2c2f33;
      color: white;
      align-self: flex-start;
      margin-right: auto;
    }
    .message-meta {
      font-size: 0.75rem;
      color: #aaa;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body data-is-admin="{{ current_user.is_admin()|string }}">
<div class="container-fluid py-4">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Chats</h5>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush" id="chatList">
            <!-- Chats will be injected here -->
          </ul>
        </div>
      </div>
    </div>

    <!-- Main Chat Panel -->
    <div class="col-md-9 d-flex flex-column">
      <div class="card flex-fill">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="chatTitle">Chat</h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-success">{{ username }}</span>
            <a href="{{ url_for('profile') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-person"></i></a>
            {% if current_user.is_admin() %}
            <a href="{{ url_for('admin_users') }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-shield-lock"></i></a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-box-arrow-right"></i></a>
            <button id="soundToggle" class="btn btn-sm btn-outline-secondary">
              Sound: <span id="soundStatus">On</span>
            </button>
          </div>
        </div>
        <div class="card-body chat-messages d-flex flex-column" id="messageContainer">
          <div class="text-muted text-center">Loading messages...</div>
        </div>
        <div class="card-footer">
          <form id="messageForm" class="d-flex gap-2">
            <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." required>
            <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Create Chat</h5></div>
      <div class="modal-body">
        <input type="text" id="chatName" class="form-control mb-2" placeholder="Group name (optional)">
        <div id="userCheckboxList" class="form-check" style="max-height: 200px; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button id="createGroupChatBtn" class="btn btn-primary">Create</button>
      </div>
    </div>
  </div>
</div>

<audio id="notifSound" src="/static/sounds/notification.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const chatId = {{ active_chat_id or 'null' }};
  const isAdmin = document.body.dataset.isAdmin === "True";
  const currentUsername = "{{ username }}";
  let lastMessageCount = 0;
  let soundEnabled = localStorage.getItem("soundEnabled") ?? "true";
  const notifSound = document.getElementById("notifSound");
  const soundStatus = document.getElementById("soundStatus");

  document.getElementById("soundToggle").addEventListener("click", () => {
    soundEnabled = soundEnabled === "true" ? "false" : "true";
    localStorage.setItem("soundEnabled", soundEnabled);
    soundStatus.textContent = soundEnabled === "true" ? "On" : "Off";
  });

  async function fetchChats() {
    const res = await fetch("/api/chats");
    const chats = await res.json();
    const list = document.getElementById("chatList");
    list.innerHTML = "";
    const globalLi = document.createElement("li");
    globalLi.className = "list-group-item d-flex justify-content-between";
    globalLi.innerHTML = `
      <a href="/" class="text-decoration-none flex-grow-1 text-reset">üåê Global Chat</a>
    `;
    list.appendChild(globalLi);

    chats.forEach(chat => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between";
      li.innerHTML = `
        <a href="/chat/${chat.id}" class="text-decoration-none flex-grow-1 text-reset">${chat.name}</a>
        ${chat.id !== 0 ? `<button class="btn btn-sm btn-danger" onclick="deleteChat(${chat.id})"><i class="bi bi-trash"></i></button>` : ""}
      `;
      list.appendChild(li);
    });
  }

  async function fetchMessages() {
    if (!chatId) return;
    const res = await fetch(`/messages?chat_id=${chatId}`);
    const messages = await res.json();
    const container = document.getElementById("messageContainer");
    container.innerHTML = "";
    messages.forEach(msg => {
      const msgDiv = document.createElement("div");
      msgDiv.className = "message " + (msg.username === currentUsername ? "own" : "other");
      msgDiv.innerHTML = `
        <div>${msg.content}</div>
        <div class="message-meta">${msg.username}</div>
        ${isAdmin ? `<form method="POST" action="/admin/delete-message/${msg.id}" class="d-inline">
          <button type="submit" class="btn btn-sm btn-outline-danger mt-1"><i class="bi bi-trash"></i></button>
        </form>` : ""}
      `;
      container.appendChild(msgDiv);
    });
    container.scrollTop = container.scrollHeight;
    if (soundEnabled === "true" && messages.length > lastMessageCount) {
      notifSound.play();
    }
    lastMessageCount = messages.length;
  }

  // Send message
  document.getElementById("messageForm").addEventListener("submit", e => {
    e.preventDefault();
    const content = document.getElementById("messageInput").value.trim();
    if (!content) return;
    fetch("/api/messages/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: chatId, content })
    }).then(res => res.json()).then(data => {
      if (data.success) {
        document.getElementById("messageInput").value = "";
        fetchMessages();
      } else {
        alert(data.error || "Failed to send.");
      }
    });
  });

  function deleteChat(id) {
    fetch(`/api/chats/delete/${id}`, { method: "DELETE" })
      .then(res => res.json())
      .then(data => {
        if (data.success) location.href = "/";
        else alert(data.error || "Could not delete chat.");
      });
  }

  // Create chat
  document.getElementById("createGroupChatBtn").addEventListener("click", () => {
    const name = document.getElementById("chatName").value;
    const selected = Array.from(document.querySelectorAll("#userCheckboxList input:checked")).map(cb => cb.value);
    if (selected.length === 0) return alert("Select at least 1 user.");
    fetch("/api/chats/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_ids: selected, name })
    }).then(res => res.json())
      .then(data => {
        if (data.success) window.location.href = `/chat/${data.chat.id}`;
        else alert(data.error || "Failed.");
      });
  });

  // Load user list for modal
  document.getElementById("newChatModal").addEventListener("shown.bs.modal", () => {
    fetch("/api/users").then(res => res.json()).then(users => {
      const list = document.getElementById("userCheckboxList");
      list.innerHTML = "";
      users.forEach(user => {
        const label = document.createElement("div");
        label.innerHTML = `
          <input type="checkbox" value="${user.id}" class="form-check-input me-2">
          ${user.username}
        `;
        list.appendChild(label);
      });
    });
  });

  // Start polling
  fetchChats();
  fetchMessages();
  setInterval(fetchChats, 2000);
  setInterval(fetchMessages, 2000);
</script>
</body>
</html>
