<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF--8">
  <title>SocialTap</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    /* General dark theme */
    body { background: #000; color: #fff }
    .card { background: #111; border: none }
    .form-control, .btn, .list-group-item { background: #1a1a1a; color: #fff; border: 1px solid #333 }
    .list-group-item:hover { background: #222 }
    
    /* Chat message area */
    .chat-messages { height: 60vh; overflow-y: auto; padding: 1rem }
    .bubble-wrap { margin-bottom: .9rem; max-width: 75% }
    .bubble-wrap.own { margin-left: auto; text-align: right }
    .bubble-wrap.other { margin-right: auto; text-align: left }
    
    /* Message bubbles */
    .message-bubble { padding: .7rem 1rem; border-radius: 1rem; word-wrap: break-word; display: inline-block; }
    .own .message-bubble { background: #ff8800; color: #000 }
    .other .message-bubble { background: #2a2a2a; color: #ff8800 }
    
    /* Message meta (username, timestamp, badges) */
    .message-meta { font-size: .75rem; color: #aaa; margin-top: .2rem }
    .badge-message { font-size: .65rem; margin-left: 0.2rem; vertical-align: text-top; }
    
    .btn-circle { width: 32px; height: 32px; padding: 0; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center }
  </style>
</head>
<body data-is-admin="{{ current_user.is_admin()|string }}">

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-3">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Chats</h5>
          <a href="/newchat" class="btn btn-sm btn-primary btn-circle"><i class="bi bi-plus-lg"></i></a>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush" id="chatList"></ul>
        </div>
      </div>
    </div>

    <div class="col-md-9 d-flex flex-column">
      <div class="card flex-fill">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="chatTitle">Chat</h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-success">{{ username }}</span>
            <!-- Invite button (hidden by default, shown for group chats) -->
            <button id="inviteBtn" class="btn btn-sm btn-outline-success btn-circle d-none">
              <i class="bi bi-link-45deg"></i>
            </button>
            <a href="{{ url_for('profile') }}" class="btn btn-sm btn-outline-secondary btn-circle"><i class="bi bi-person"></i></a>
            {% if current_user.is_admin() %}
            <a href="{{ url_for('admin_users') }}" class="btn btn-sm btn-outline-primary btn-circle"><i class="bi bi-shield-lock"></i></a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger btn-circle"><i class="bi bi-box-arrow-right"></i></a>
            <button id="soundToggle" class="btn btn-sm btn-outline-secondary">Sound: <span id="soundStatus">On</span></button>
          </div>
        </div>

        <div class="card-body chat-messages d-flex flex-column" id="messageContainer">
          <div class="text-muted text-center">Loading…</div>
        </div>

        <div class="card-footer">
          <form id="messageForm" class="d-flex gap-2 mb-2">
            <input id="messageInput" class="form-control" placeholder="Type a message…" required>
            <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
          </form>
          <div id="participantBox" class="text-center text-muted small"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="notifSound" src="/static/sounds/notification.mp3" preload="auto"></audio>
<input type="hidden" id="activeChatId" value="{{ active_chat_id if active_chat_id is not none else '' }}">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// -----------------------------
// Setup and globals
// -----------------------------
const isAdmin  = document.body.dataset.isAdmin === 'True';
const me       = "{{ username }}";
const meId     = {{ current_user.id }};
let soundOn    = (localStorage.getItem('soundEnabled') ?? 'true') === 'true';
document.getElementById('soundStatus').textContent = soundOn ? 'On' : 'Off';
const notifSound = document.getElementById('notifSound');
const titleEl = document.getElementById('chatTitle');
const inviteBtn = document.getElementById('inviteBtn');
let chatId     = document.getElementById('activeChatId').value === '' ? null : Number(document.getElementById('activeChatId').value);
let lastMsgCount = 0;
let lastMsgIds = new Set();
let initialized = false;

// Escape HTML to prevent XSS
const esc = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const api = (u, o = {}) => fetch(u, o).then(r => r.json());

// -----------------------------
// Load participants (and show invite button if group)
// -----------------------------
async function loadParticipants() {
  const box = document.getElementById('participantBox');
  if (chatId === null) {
    box.innerHTML = '';
    inviteBtn.classList.add('d-none');
    return;
  }

  const res = await fetch(`/api/chat/${chatId}`);
  const data = await res.json();
  if (!data.participants) return;

  const isOwner = data.participants.length > 0 && data.participants[0].id === meId;

  // Only show invite button for non-private group chats
  if (!data.is_private) {
    inviteBtn.classList.remove('d-none');
    inviteBtn.onclick = async () => {
      const res = await fetch('/api/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId })
      });
      const j = await res.json();
      if (j.success) {
        prompt("Invite link:", j.link);
      } else {
        alert(j.error || "Error generating invite");
      }
    };
  } else {
    inviteBtn.classList.add('d-none');
  }

  if (!isOwner) {
    box.innerHTML = '';
    return;
  }

  box.innerHTML = `<strong>Group Members:</strong><ul class="list-unstyled">` + 
    data.participants.map(p => {
      if (p.id === meId) return `<li>${esc(p.username)} (You)</li>`;
      return `<li>${esc(p.username)} <button class="btn btn-sm btn-outline-danger btn-circle ms-1" onclick="removeMember(${p.id})"><i class="bi bi-x-lg"></i></button></li>`;
    }).join('') + `</ul>`;
}

// -----------------------------
// Other functions remain unchanged (loadChats, loadMessages, removeMember, send, etc.)
// -----------------------------

// Initialize
loadChats(); loadMessages(); loadParticipants();
setInterval(loadChats, 5000);
setInterval(() => { loadMessages(); loadParticipants(); }, 1000);
</script>

</body>
</html>
