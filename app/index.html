<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SocialTap">
  <title>SocialTap</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='launch.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-is-admin="{{ current_user.is_admin()|string }}">
  <!-- ... your HTML above remains unchanged ... -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const messageContainer = document.getElementById('messageContainer');
      const chatId = document.getElementById('activeChatId')?.value || '';
      const isAdmin = document.body.dataset.isAdmin === "True";
      const currentUsername = "{{ username }}";

      function escapeHTML(str) {
        return str.replace(/[&<>"']/g, m => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[m]);
      }

      function loadMessages() {
        if (!chatId) return;
        fetch(`/messages?chat_id=${chatId}`)
          .then(res => res.json())
          .then(messages => {
            messageContainer.innerHTML = '';
            messages.forEach(msg => {
              const div = document.createElement('div');
              div.className = 'message' + (msg.username === currentUsername ? ' own' : ' other');
              let inner = `
                <div class="message-bubble">${escapeHTML(msg.content)}</div>
                <div class="message-meta">${escapeHTML(msg.username)} â€¢ ${escapeHTML(msg.timestamp)}</div>
              `;
              if (isAdmin) {
                inner += `
                  <form method="POST" action="/admin/delete-message/${msg.id}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger mt-1"><i class="bi bi-trash"></i> Delete</button>
                  </form>
                `;
              }
              div.innerHTML = inner;
              messageContainer.appendChild(div);
            });
            messageContainer.scrollTop = messageContainer.scrollHeight;
          });
      }

      // Initial load + polling
      loadMessages();
      const pollingInterval = setInterval(loadMessages, 2000);

      // Send message logic
      const form = document.getElementById('messageForm');
      form?.addEventListener('submit', e => {
        e.preventDefault();
        const input = document.getElementById('messageInput');
        const content = input.value.trim();
        if (!content) return;

        const formData = new FormData();
        formData.append('message', content);
        formData.append('chat_id', chatId);

        fetch('/send', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              input.value = '';
              // delay to avoid immediate spam trigger
              setTimeout(loadMessages, 1000);
            } else {
              alert(data.error || 'Failed to send message.');
            }
          });
      });

      // Delete chat
      window.deleteChat = function(chatId) {
        const userId = {{ current_user.id }};
        fetch(`/api/chats/delete/${chatId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Chat deleted successfully.');
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (chatItem) chatItem.remove();
          } else {
            alert(data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while deleting the chat.');
        });
      };

      // Sound toggle
      const notificationSound = new Audio('/static/sounds/notification.mp3');
      let soundEnabled = localStorage.getItem('soundEnabled');
      if (soundEnabled === null) soundEnabled = 'true';
      localStorage.setItem('soundEnabled', soundEnabled);

      const toggleBtn = document.getElementById('soundToggle');
      const soundStatus = document.getElementById('soundStatus');
      if (toggleBtn && soundStatus) {
        soundStatus.textContent = soundEnabled === 'true' ? 'On' : 'Off';
        toggleBtn.addEventListener('click', () => {
          soundEnabled = soundEnabled === 'true' ? 'false' : 'true';
          localStorage.setItem('soundEnabled', soundEnabled);
          soundStatus.textContent = soundEnabled === 'true' ? 'On' : 'Off';
        });
      }
    });
  </script>


</body>
</html>
