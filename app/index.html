<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SocialTap</title>
  <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SocialTap">

  <style>
    /* Message container styles */
    #chatContainer {
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 1rem;
      border-radius: 0.5rem;
      background-color: #1c1c1e;
    }

    .chat-message {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #333;
    }

    .chat-username {
      font-weight: bold;
      display: inline-block;
      margin-right: 0.5rem;
    }

    .chat-badge {
      display: inline-block;
      margin-left: 0.2rem;
      padding: 0.1rem 0.3rem;
      font-size: 0.75rem;
      border-radius: 0.25rem;
      background-color: #0dcaf0; /* Bootstrap info color */
      color: #000;
    }

    .chat-timestamp {
      font-size: 0.75rem;
      color: #999;
      float: right;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8">

        <!-- Chat Messages Container -->
        <div id="chatContainer" class="mb-3">
          <!-- Messages will be dynamically injected here -->
        </div>

        <!-- Message Input Form -->
        <form id="chatForm" class="d-flex">
          <input type="text" id="messageInput" class="form-control me-2" placeholder="Type your message..." required>
          <button type="submit" class="btn btn-primary">Send</button>
        </form>

      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="py-3 mt-4">
    <div class="container text-center">
      <p class="text-muted small">
        <a href="{{ url_for('privacy_policy') }}" class="text-decoration-none text-muted me-3">Privacy Policy</a>
        <a href="{{ url_for('terms_of_service') }}" class="text-decoration-none text-muted">Terms of Service</a>
        <br><br>
        <a href="/download" class="text-decoration-none text-muted">Download</a>
        <br><br>
        <a href="/apidocs" class="text-decoration-none text-muted">API Docs</a>
      </p>
      <p class="text-muted small mb-0">&copy; 2025 SocialTap. All rights reserved, protected by the </p>
      <a href="https://www.mozilla.org/media/MPL/2.0/index.f75d2927d3c1.txt" class="text-decoration-none text-muted">Mozilla Public License 2</a>
    </div>
  </footer>

  <script>
    // Function to append a single message to the chat container
    function appendMessage(message) {
      const container = document.getElementById('chatContainer');

      // Create message wrapper
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('chat-message');

      // Create username element
      const usernameSpan = document.createElement('span');
      usernameSpan.classList.add('chat-username');
      usernameSpan.textContent = message.username;

      // Append badges after username
      if (message.badges && message.badges.length > 0) {
        message.badges.forEach(badge => {
          const badgeSpan = document.createElement('span');
          badgeSpan.classList.add('chat-badge');
          badgeSpan.textContent = badge;
          usernameSpan.appendChild(badgeSpan);
        });
      }

      // Create message content element
      const contentSpan = document.createElement('span');
      contentSpan.textContent = `: ${message.content}`;

      // Create timestamp element
      const timeSpan = document.createElement('span');
      timeSpan.classList.add('chat-timestamp');
      timeSpan.textContent = message.timestamp;

      // Combine elements
      msgDiv.appendChild(usernameSpan);
      msgDiv.appendChild(contentSpan);
      msgDiv.appendChild(timeSpan);

      // Append to container
      container.appendChild(msgDiv);

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    // Function to load messages from API (simulate fetch)
    async function loadMessages() {
      try {
        const response = await fetch('/messages?fetchall=true');
        const data = await response.json();
        const container = document.getElementById('chatContainer');
        container.innerHTML = ''; // Clear previous messages

        data.forEach(msg => {
          appendMessage(msg);
        });
      } catch (err) {
        console.error('Error fetching messages:', err);
      }
    }

    // Load messages when page loads
    window.addEventListener('DOMContentLoaded', () => {
      loadMessages();
    });

    // Handle sending new message
    document.getElementById('chatForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('messageInput');
      const content = input.value.trim();
      if (!content) return;

      try {
        const response = await fetch('/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `message=${encodeURIComponent(content)}`
        });
        const result = await response.json();
        if (result.success) {
          appendMessage({
            username: result.message.username,
            content: result.message.content,
            timestamp: result.message.timestamp,
            badges: result.message.badges || []
          });
          input.value = '';
        } else {
          alert(result.error || 'Failed to send message.');
        }
      } catch (err) {
        console.error('Error sending message:', err);
      }
    });
  </script>
</body>
</html>
